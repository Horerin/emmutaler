OIDS = {
    "oidRsa": [ 42, 134, 72, 134, 247, 13, 1, 1, 1 ],
    "oidMd2Rsa": [ 42, 134, 72, 134, 247, 13, 1, 1, 2 ],
    "oidMd5Rsa": [ 42, 134, 72, 134, 247, 13, 1, 1, 4 ],
    "oidSha1Rsa": [ 42, 134, 72, 134, 247, 13, 1, 1, 5 ],
    "oidSha256Rsa": [ 42, 134, 72, 134, 247, 13, 1, 1, 11 ],
    "oidSha384Rsa": [ 42, 134, 72, 134, 247, 13, 1, 1, 12 ],
    "oidSha512Rsa": [ 42, 134, 72, 134, 247, 13, 1, 1, 13 ],
    "oidSha224Rsa": [ 42, 134, 72, 134, 247, 13, 1, 1, 14 ],
    "oidEcPubKey": [ 42, 134, 72, 206, 61, 2, 1 ],
    "oidSha1Ecdsa": [ 42, 134, 72, 206, 61, 4, 1 ],
    "oidSha224Ecdsa": [ 42, 134, 72, 206, 61, 4, 3, 1 ],
    "oidSha256Ecdsa": [ 42, 134, 72, 206, 61, 4, 3, 2 ],
    "oidSha384Ecdsa": [ 42, 134, 72, 206, 61, 4, 3, 3 ],
    "oidSha512Ecdsa": [ 42, 134, 72, 206, 61, 4, 3, 4 ],
    "oidMd2": [ 42, 134, 72, 134, 247, 13, 2, 2 ],
    "oidMd4": [ 42, 134, 72, 134, 247, 13, 2, 4 ],
    "oidMd5": [ 42, 134, 72, 134, 247, 13, 2, 5 ],
    "oidSha1": [ 43, 14, 3, 2, 26 ],
    "oidSha256": [ 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 1 ],
    "oidSha384": [ 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 2 ],
    "oidSha512": [ 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 3 ],
    "oidSha224": [ 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 4 ],
    
    "oidSubjectKeyIdentifier": [ 85, 29, 14 ],
    "oidKeyUsage": [ 85, 29, 15 ],
    "oidPrivateKeyUsagePeriod": [ 85, 29, 16 ],
    "oidSubjectAltName": [ 85, 29, 17 ],
    "oidIssuerAltName": [ 85, 29, 18 ],
    "oidBasicConstraints": [ 85, 29, 19 ],
    "oidCrlDistributionPoints": [ 85, 29, 31 ],
    "oidCertificatePolicies": [ 85, 29, 32 ],
    "oidAnyPolicy": [ 85, 29, 32, 0 ],
    "oidPolicyMappings": [ 85, 29, 33 ],
    "oidAuthorityKeyIdentifier": [ 85, 29, 35 ],
    "oidPolicyConstraints": [ 85, 29, 36 ],
    "oidExtendedKeyUsage": [ 85, 29, 37 ],
    "oidAnyExtendedKeyUsage": [ 85, 29, 37, 0 ],
    "oidInhibitAnyPolicy": [ 85, 29, 54 ],
    "oidAuthorityInfoAccess": [ 43, 6, 1, 5, 5, 7, 1, 1 ],
    "oidSubjectInfoAccess": [ 43, 6, 1, 5, 5, 7, 1, 11 ],
    "oidAdOCSP": [ 43, 6, 1, 5, 5, 7, 48, 1 ],
    "oidAdCAIssuer": [ 43, 6, 1, 5, 5, 7, 48, 2 ],
    "oidNetscapeCertType": [ 0x60, 0x86, 0x48, 0x01, 0x86, 0xf8, 0x42, 0x01, 1 ],
    "oidEntrustVersInfo": [ 42, 134, 72, 0x86, 0xf6, 0x7d, 0x07, 0x41, 0 ],
    "oidMSNTPrincipalName": [ 43, 6, 0x01, 0x04, 0x01, 0x82, 0x37, 0x14, 2, 3 ],

    "oidQtCps": [ 43, 6, 1, 5, 5, 7, 2, 1 ],
    "oidQtUNotice": [ 43, 6, 1, 5, 5, 7, 2, 2 ],

    "oidCommonName": [ 85, 4, 3 ],
    "oidCountryName": [ 85, 4, 6 ],
    "oidLocalityName": [ 85, 4, 7 ],
    "oidStateOrProvinceName": [ 85, 4, 8 ],
    "oidOrganizationName": [ 85, 4, 10 ],
    "oidOrganizationalUnitName": [ 85, 4, 11 ],
    "oidDescription": [ 85, 4, 13 ],
    "oidEmailAddress": [ 42, 134, 72, 134, 247, 13, 1, 9, 1 ],
    "oidFriendlyName": [ 42, 134, 72, 134, 247, 13, 1, 9, 20 ],
    "oidLocalKeyId": [ 42, 134, 72, 134, 247, 13, 1, 9, 21 ],
    "oidExtendedKeyUsageServerAuth": [ 43, 6, 1, 5, 5, 7, 3, 1 ],
    "oidExtendedKeyUsageClientAuth": [ 43, 6, 1, 5, 5, 7, 3, 2 ],
    "oidExtendedKeyUsageCodeSigning": [ 43, 6, 1, 5, 5, 7, 3, 3 ],
    "oidExtendedKeyUsageEmailProtection": [ 43, 6, 1, 5, 5, 7, 3, 4 ],
    "oidExtendedKeyUsageOCSPSigning": [ 43, 6, 1, 5, 5, 7, 3, 9 ],
    "oidExtendedKeyUsageIPSec": [ 43, 6, 1, 5, 5, 8, 2, 2 ],
    "oidExtendedKeyUsageMicrosoftSGC": [ 43, 6, 0x01, 0x04, 0x01, 0x82, 0x37, 10, 3, 3 ],
    "oidExtendedKeyUsageNetscapeSGC": [ 0x60, 0x86, 0x48, 0x01, 0x86, 0xf8, 0x42, 0x04, 1 ],
    "oidAppleSecureBootCertSpec": [ 42, 134, 72, 0x86, 0xf7, 0x63, 0x64, 6, 1, 1 ],
    "oidAppleSecureBootTicketCertSpec": [ 42, 134, 72, 0x86, 0xf7, 0x63, 0x64, 6, 1, 11 ],
    "oidAppleImg4ManifestCertSpec": [42, 134, 72, 0x86, 0xf7, 0x63, 0x64, 6, 1, 15 ],
    "oidAppleProvisioningProfile": [42, 134, 72, 0x86, 0xf7, 0x63, 0x64, 6, 2, 1 ],
    "oidAppleApplicationSigning": [ 42, 134, 72, 0x86, 0xf7, 0x63, 0x64, 6, 1, 3 ],
    "oidAppleInstallerPackagingSigningExternal": [ 42, 134, 72, 0x86, 0xf7, 0x63, 0x64, 6, 1, 16 ],
    "oidAppleExtendedKeyUsageAppleID": [ 42, 134, 72, 0x86, 0xf7, 0x63, 0x64, 4, 7 ],
    "oidAppleExtendedKeyUsageShoebox": [ 42, 134, 72, 0x86, 0xf7, 0x63, 0x64, 4, 14 ],



    "oidAppleIntmMarkerAppleID": [ 42, 134, 72, 0x86, 0xf7, 0x63, 0x64, 6, 2, 3 ],
    "oidAppleIntmMarkerAppleID2": [42, 134, 72, 0x86, 0xf7, 0x63, 0x64, 6, 2, 7 ]
}

from emmutaler.log import get_logger
log = get_logger(__name__)
import ida_bytes
import idaapi
import ida_xref
import ida_name
import idautils
import ida_entry
import ida_typeinf
import ida_struct
import struct

def find_oid_der_item(oid, addr):
    name, data = oid
    item_bytes = struct.pack("QQ", addr, len(data))
    # log.info("Searching for bytes: %s, bc suspected address: 0x%x", item_bytes, addr)
    ea = 0
    return ida_bytes.bin_search(ea, idaapi.BADADDR, item_bytes, None, ida_bytes.BIN_SEARCH_FORWARD, 0)

def find_oid(oid):
    name, data = oid
    ea = 0
    for i in range(0, 100):
        ea = ida_bytes.bin_search(ea, idaapi.BADADDR, bytes(data), None, ida_bytes.BIN_SEARCH_FORWARD, 0)
        if ea == idaapi.BADADDR:
            break
        curr_ea = ea
        ea += 4
        dref = find_oid_der_item(oid, curr_ea)
        if dref == idaapi.BADADDR:
            continue

        lenAddr = dref + 8
        if idaapi.get_qword(lenAddr) == len(data):
            # length seems to match, so this is probably right
            return curr_ea
    return idaapi.BADADDR

def annotate_oid(oid, addr):
    name, data = oid
    ff = ida_bytes.get_flags(addr)
    if ida_bytes.is_tail(ff):
        head = ida_bytes.prev_not_tail(addr)
        ida_bytes.create_byte(head, 1)
    ida_bytes.create_byte(addr, len(data), True)
    ida_name.set_name(addr, name, 0)
    dref = find_oid_der_item(oid, addr)
    sid = idaapi.get_struc_id("DERItem")
    ida_bytes.create_data(dref, ida_bytes.stru_flag(), 16, sid)
    ida_name.set_name(dref, f"{name}Item", 0)

def annotate_all():
    for oid in OIDS.items():
        addr = find_oid(oid)
        if addr == idaapi.BADADDR:
            log.info("Couldn't find oid %s", oid[0])
            continue
        annotate_oid(oid, addr)